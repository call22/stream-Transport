# 实验说明

龙玉凤  2017011470   软71

### 一. 实验环境

CPU： Intel(R) Core(TM) i5-6200U CPU @ 2.30GHz
内存：8GB
操作系统：Windows10家庭版
编程语言：python2（UDP）/python3（FTP客户端）/C（FTP服务端）

### 二. task1 实现说明

1. server端:

   创建socket –> 监听 -> 连接客户端, 接受请求  –-> 解析请求并做出响应  --> 返回处理结果  -->  手动关闭 

2. client端:

   创建socket --> 与服务端连接 --> 接受用户GUI点击指令 -->  发送命令并等待响应 --> 根据响应调整GUI的组件显示  -->  通过teardown退出连接

3. 图片传输:  建立图片仓库类, 管理图片的播放.  rtsp通过调用此类, 实现对视频播放的控制.

### 三. task2 实现说明

1. server端,  client端.  同task1

2. 视频传输: 

   建立视频仓库类, 管理视频的播放.  因为对mp4的编解码一直没有弄懂, 故退而求其次, 使用opencv将视频每一帧压缩转换为jpg图片, 再用与task1相同的方式传输, 显示.

### 四. 遇到的bug和相关解决方案

1. bug1. 无法实现多线程: 思路

    --> 使用threading.local()建立单独的数据库。但是对于rtp无法共享, 因为rtp需要单独建立线程, 而此时无法获取另一线程上的rtsp相关参数，故失败

    --> 建立全局dict变量。 以线程ident为key, 存储每个线程的值. 在rtp函数中, 通过传参获取key值。但是不知为何, pycharm报错"unexcept type"(大概意思, 所传参数的类型无法确定), 找不到解决方案。

   --> 在main中多线程, 建立多个server对象, 每个server对象,仅服务一个客户端. 这样在逻辑和代码实现时都可以避免数据共享和私有的问题.

2. bug2: 视频的计时播放： 思路

   双方都通过time计时 , 但是对于变倍速无法正确计时, 且计时不准确. 

   --> 通过帧率计时。server端传输视频的帧率，总帧数和当前的帧序号，client端计算得到当前的视频播放时间。

3. bug3: 在server端rtp包传输过慢。

   原因：cv2压缩和Image压缩, 最初用Image压缩图片, 耗时超过帧率, 导致视频无法正常速度播放.

   解决：改用cv2.resize（）压缩

4. bug4:cv2.set()函数总是报错, 无法实现跳转到某一时间播放.

    原因: python多线程, 冲突访问. 

    解决方法: 用threading.Lock() 给共同访问的资源加锁.   导致整体响应变慢, 尤其拖动进度条时, 主线程无法竞争到资源导致卡顿。lock（）对于多个client时无法成立， 因为大家公用一个lock，当然不行。

   ---> 将在rtsp和rtp中对视频库的修改动作， 全部移到rtp中， 从而避免冲突访问。（虽然很暴力）

5. bug5: 到达结尾后无法退回。 尚未解决。

6. bug6: 由于传输模式限制, 无法解决:  对于高清和低像素视频, 无法同时支持。